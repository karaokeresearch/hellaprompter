<html>
    <head><title>socketprompter</title>
   <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	 <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        </head>
<body>
<script src="jquery-3.3.1.min.js"></script>
<script src="hammer.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>

@font-face {
    font-family: Bitstream Vera Sans Mono;
    src: url('VeraMono.eot?') format('embedded-opentype'),
    url('VeraMono.ttf') format('truetype');
}

#scrollpart {
        font-family: Bitstream Vera Sans Mono;
        font-size: 11vw;
        color: #FFFFFF;
        background-color: #000000;
        width: 100vw;
        word-wrap: break-word;
        white-space: pre-wrap;
       	margin-bottom:300vw;
}


#letterbar {
	 visibility: hidden;
	 position: fixed;
	 top: 56.25vw;
   left: 0px;
   width: 100vw;
   border: 0.25vh solid  rgba(128, 128, 128, .50);
   color:red;
}


body{
	overflow-x:hidden;	
}


html, body { 
    height: 100%; 
    width: 100%; 
    background-color: #AAAAAA;
    margin: 0; 
    padding: 0;    
    }
   
</style>


<div id="scrollpart" onclick="goFullScreen()">
</div>

<div id="letterbar"></div>
<br>
<!--
<div id="extragutter" onclick="gofullScreen()"></div>
</body>

-->


<script>
var socket = io.connect();
var master=false;
var fontsize=-1;
var sensitivity=.02; //how sensitive pinch control is for font resizing
var scrollPercent=0;    

var myElement= document.querySelector("#scrollpart"); //hammer stuff
var hammertime = new Hammer(myElement);
    hammertime.get('pinch').set({ enable: true });

var flippedHorizontal=false;
//var xmitThrot=0;
//var lastTimestamp=0;
var firstScroll=true;



var queryDict = {};    //querystring JSON
    location.search.substr(1).split("&").forEach(function(item) {
        queryDict[item.split("=")[0]] = item.split("=")[1]
    })





var manualFontSize=function(bigger){
if(bigger){fontsize+=1}else{fontsize-=1};
  if(queryDict.control){
        socket.emit('fontsize', {
            fontsize: fontsize
    	});
    } 		
  
	
};
	



var scrollPage = function(){
    var gutterPercentage = window.innerHeight /$("#scrollpart").height();
    var finalHeight=$("#scrollpart").height();
    var remainder=finalHeight -$('body').scrollTop();
    var percentageDone = 1-(remainder/finalHeight);
    var percentageLeft = remainder/finalHeight;
    //if (Date.now() - xmitThrot >9){
	    //console.log(percentageDone);
	    socket.emit('scrollPos', {
				position: percentageDone
			});
	    //xmitThrot  = Date.now();   
	  //}
};


var lockOrientation= function() {
    if (typeof screen.orientation !== "undefined" && screen.orientation.lock !== "undefined" ){
        screen.orientation.lock('portrait-primary');
    } else if(window.screen.lockOrientation){
        window.screen.lockOrientation('portrait-primary');
    } else if(window.screen.mozLockOrientation){
        window.screen.mozLockOrientation('portrait-primary');
    } else if (window.screen.msLockOrientation){
        window.screen.msLockOrientation('portrait-primary');
    }
};


var goFullScreen = function(){


	setTimeout(function(scrollPercent){ //have to do this because fullscreen scrolls to top of screen for some reason
	    var finalHeight=$("#scrollpart").height(); // - ($("#scrollpart").height() *data.gutterPercentage);
	    var myPos = finalHeight * scrollPercent;
	    $('body').animate({scrollTop: myPos+ "px"}, 0, 'linear'); 			
	},100,scrollPercent); 

      if(document.documentElement.requestFullscreen) {
         document.documentElement.requestFullscreen();
      } else if(document.documentElement.webkitRequestFullscreen) {
         document.documentElement.webkitRequestFullscreen();
      } else if(document.documentElement.mozRequestFullScreen) {
      	console.log("moz");
         document.documentElement.mozRequestFullScreen();
      } else if(document.documentElement.msRequestFullscreen) {
         document.documentElement.msRequestFullscreen();
      }

//	setTimeout(function(){
//	lockOrientation();
//		},1); //you've got to be kidding me. This fixes Firefox orientation lock #haxx #findabetterway
	

    var finalHeight=$("#scrollpart").height(); // - ($("#scrollpart").height() *data.gutterPercentage);
    var myPos = finalHeight * scrollPercent;

};

var realignScreen=function(){
	var finalHeight=$("#scrollpart").height(); // - ($("#scrollpart").height() *data.gutterPercentage);

  if (flippedHorizontal==true){
  	myPos= finalHeight- (finalHeight *scrollPercent) - $(window).height();
  }
  else{
  	myPos = finalHeight * scrollPercent;
  }
  

	    	    
	$('body').animate({scrollTop: myPos+ "px"}, 0, 'linear');   	    	    
} 


$( document ).ready(function() {

    $.get("script.txt", function(data){
      $("#scrollpart").text(data);
    });   
    if(queryDict.control){
    $("#letterbar").css("visibility", "visible");
  	}
    $( window ).scroll(function() {
      if(queryDict.control){
        scrollPage(); //scroll the page for everyone if control=true in your querystring
        }
    });    
    
    
    $(window).resize(function(){
    	realignScreen();
		});
    
    socket.on('bScrollPos', function(data) { //listen for position changes
    	
        scrollPercent=data.position;
       //  if (data.timestamp >lastTimestamp){ //only needed if connection method isn't websockets
	        //console.log(scrollPercent);
	    		if (!queryDict.control){ //not controlling, passive terminal	    	    
	    	  //  console.log("bscrollPos",data);
	    	    realignScreen();
	    	    
	    	    if (firstScroll==true){//first loads are sometimes broke
       	 
       	 		setTimeout(function(){realignScreen();},500);
       	 		firstScroll=false;
       	  	
       	  	}
	    	    
	        }    	    
	    	//}else{console.log("data out of order", lastTimestamp, data.timestamp);}
	   //lastTimestamp=data.timestamp;	
    });

    socket.on('bfontsize', function(data) { //listen for font size changes
    	
    	//console.log("receiving font size changes");
        fontsize=data.fontsize;
        $("#scrollpart").css("font-size", data.fontsize + "vw");
    });


	$(document).keypress(function(e) {
	    //console.log(e.which);
	    if(e.which==45 ||e.which==95){manualFontSize(false)}
	    if(e.which==43 ||e.which==61){manualFontSize(true)}
	});


	
	$('#scrollpart').bind('touchstart', function(ev) {  //these two make it so pinch isn't blocking.
	    if (ev.originalEvent.touches.length===1){
	        hammertime.get('pinch').set({ enable: false});
	    }else{hammertime.get('pinch').set({ enable: true});}
	});
	
	
	$('#scrollpart').bind('touchend', function(ev) {
	   
	    hammertime.get('pinch').set({ enable: false});
	});


    
hammertime.on('pinch',function(ev){

  var sensitiveScale;

	if(queryDict.control){
    if (ev.scale>1){ //growing
        sensitiveScale = ((ev.scale -1) * sensitivity) +1;
    }else{ //shrinking
        sensitiveScale = 1-((1 -ev.scale) * sensitivity);
    }
    
    //console.log(fontsize, ev.scale, sensitiveScale);
		
    fontsize=(fontsize*sensitiveScale);
    if (fontsize<2){fontsize=2};
    
        socket.emit('fontsize', {
            fontsize: fontsize
    	});
    } 		
	
});


if(queryDict.flip=="horizontal"){
	$("#scrollpart").css("transform", "scale(1, -1)");
	flippedHorizontal= true;
}

if(queryDict.flip=="vertical"){
	$("#scrollpart").css("transform", "scale(-1, 1)");
}

if(queryDict.flip=="both"){
	$("#scrollpart").css("transform", "scale(-1, -1)");
	flippedHorizontal= true;
	
}

if (queryDict.control !="true"){
	$("body").css("overflow-y", "hidden");	//get rid of right scroll bar if you're not transmitting
}

	 

});     
        
</script>
</html>